# ApplicationContext refresh()

5.1.5-RELEASE 버전 기준으로 작성하였다.

### ApplicationContext refresh()
Spring 의 ApplicationContext 가 refresh 될 때, 어떤 과정을 거치는지 알아보자.  
refresh() 는 ```ConfigurableApplicationContext``` 인터페이스의 함수이다. BeanFactory 의 초기화가 이 부분에서 진행되고, 
Bean 이 등록되는 과정 등이 포함되어 있다.  
함수 주석을 보면, XML 파일, 프로퍼티 파일 관계형 DB 등의 설정을 갱신 또는 불러오는 함수라고 설명 되어있다.
> Load or refresh the persistent representation of the configuration,
> which might an XML file, properties file, or relational database schema.

### AbstractApplicationContext refresh()
주석을 유심히 살펴보자. 
```
public void refresh() throws BeansException, IllegalStateException {
    synchronized (this.startupShutdownMonitor) {
        // Prepare this context for refreshing. 
        prepareRefresh(); //...........................................................(1)

        // Tell the subclass to refresh the internal bean factory.
        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); //.....(2)

        // Prepare the bean factory for use in this context.
        prepareBeanFactory(beanFactory); //............................................(3)

        try {
            // Allows post-processing of the bean factory in context subclasses.
            postProcessBeanFactory(beanFactory); //....................................(4)

            // Invoke factory processors registered as beans in the context.
            invokeBeanFactoryPostProcessors(beanFactory); //...........................(5)

            // Register bean processors that intercept bean creation.
            registerBeanPostProcessors(beanFactory); //................................(6)

            // Initialize message source for this context.
            initMessageSource(); //....................................................(7)

            // Initialize event multicaster for this context.
            initApplicationEventMulticaster(); //......................................(8)

            // Initialize other special beans in specific context subclasses.
            onRefresh(); //............................................................(9)

            // Check for listener beans and register them.
            registerListeners(); //....................................................(10)

            // Instantiate all remaining (non-lazy-init) singletons.
            finishBeanFactoryInitialization(beanFactory); //...........................(11)

            // Last step: publish corresponding event.
            finishRefresh(); //........................................................(12)
        }

        catch (BeansException ex) {
            // ...

        }

        finally {
            // ...
        }
    }
}
```
    1. context를 refresh 하기 위한 준비. 현재 시간을 기록하고, context의 상태 값을 true 로 수정한다.
    2. 빈팩토리 생성 및 bean definition 로드
    3. Prepare the bean factory for use in this context.
    4. Allows post-processing of the bean factory in context subclasses.
    5. Invoke factory processors registered as beans in the context.
    6. Register bean processors that intercept bean creation.
    7. Initialize message source for this context.
    8. Initialize event multicaster for this context.
    9. Initialize other special beans in specific context subclasses.
    10. Check for listener beans and register them.
    11. Instantiate all remaining (non-lazy-init) singletons.
    12. Last step: publish corresponding event.